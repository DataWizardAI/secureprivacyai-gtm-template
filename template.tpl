___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Secure Privacy Banner",
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Secure Privacy",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Secure Privacy Consent Banner\nMore information: https://secureprivacy.ai/",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "id",
    "displayName": "ID",
    "simpleValueType": true
  },
  {
    "type": "GROUP",
    "name": "defaultSettings",
    "displayName": "Consent Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "settingsTable",
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "ad_storage",
              "displayName": "Advertising",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "If set to \u003cstrong\u003edenied\u003c/strong\u003e, Google\u0027s advertising tags and pixels will not be able to read or write first-party cookies. The use of third-party cookies is limited to only spam and fraud detection purposes. \u003ca href\u003d\"https://support.google.com/analytics/answer/9976101#behavior\"\u003eMore information\u003c/a\u003e"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analytics_storage",
              "displayName": "Analytics",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted",
              "help": "If set to \u003cstrong\u003edenied\u003c/strong\u003e, Google Analytics tags will not read or write the first-party cookie, and data collected to Google Analytics will not utilize persistent cookie identifiers (the identifiers are reset with every page load). \u003ca href\u003d\"https://support.google.com/analytics/answer/9976101#behavior\"\u003eMore information\u003c/a\u003e."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalization_storage",
              "displayName": "Personalization",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionality_storage",
              "displayName": "Functionality",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "security_storage",
              "displayName": "Security",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "wait_for_update",
              "displayName": "Wait for Update",
              "simpleValueType": true,
              "valueUnit": "milliseconds",
              "defaultValue": 20000,
              "help": "How long to wait (in milliseconds) for an \u003cstrong\u003eUpdate\u003c/strong\u003e command before firing Google tags that have been queued up."
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "regions",
              "displayName": "Regions",
              "simpleValueType": true,
              "defaultValue": "all",
              "help": "Apply this setting to users from these \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-2\"\u003eregions\u003c/a\u003e (provide a comma-separated list). If you select \u003cstrong\u003eall\u003c/strong\u003e, the setting will apply to all users."
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Add Setting",
        "editRowTitle": "Edit Setting",
        "newRowTitle": "Add Setting",
        "valueValidators": [
          {
            "type": "TABLE_ROW_COUNT",
            "args": [
              1
            ],
            "errorMessage": "You must add at least one default setting."
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const dataLayerPush = require('createQueue')('dataLayer');
const log = require('logToConsole');
const setDefaultConsentState = require('setDefaultConsentState');

const injectScript = require('injectScript');
const encodeUriComponent = require('encodeUriComponent');
const queryPermission = require('queryPermission');
const createQueue = require('createQueue');
const setInWindow = require('setInWindow');
const id = data.id;


function after_inject() {
  const setting_arr = [];

  // Process default consent state
  data.settingsTable.forEach(setting => {
    const settingObject = {
      ad_storage: setting.ad_storage,
      ad_user_data: setting.ad_storage,
      ad_personalization: setting.ad_storage,
      analytics_storage: setting.analytics_storage,
      personalization_storage: setting.personalization_storage,
      functionality_storage: setting.functionality_storage,
      security_storage: setting.security_storage,
      wait_for_update: setting.wait_for_update
    };
    if (setting.regions !== 'all') {
      settingObject.region = setting.regions.split(',').map(r => r.trim());
    }
    setting_arr.push(settingObject);
    setDefaultConsentState(settingObject);
  });

  // push settings to the data layer
  dataLayerPush({
    event: 'gtm_default_consent_settings',
    settings: setting_arr
  });

  // Call data.gtmOnSuccess when the tag is finished.
  log('secureprivacy.ai injected');
  log('Uptading the window.sp_gcm_initialised');
  setInWindow('sp_gcm_initialised', true);
  data.gtmOnSuccess();
  return ;
}

let scriptUrl = 'https://app.secureprivacy.ai/script/' + encodeUriComponent(id) + '.js';
//let scriptUrl = 'https://frontend-test.secureprivacy.ai/script/' + encodeUriComponent(id) + '.js';

if (queryPermission('inject_script', scriptUrl)) {
  injectScript(scriptUrl, after_inject, data.gtmOnFailure);
} else {
  data.gtmOnFailure();
}

___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.secureprivacy.ai/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "sp_gcm_initialised"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
            {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
            {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      }
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: default settings sent
  code: |-
    let index = 1;
    mock('createArgumentsQueue', () => {
      return function() {
        if (arguments[0] === 'consent' && index === 1) {
          assertThat(arguments[2]).isEqualTo({
            ad_storage: 'granted',
            analytics_storage: 'denied',
            personalization_storage: 'denied',
            functionality_storage: 'denied',
            security_storage: 'denied',
            wait_for_update: 500
          });
          index++;
        } else if (arguments[0] === 'consent' && index === 2) {
          assertThat(arguments[2]).isEqualTo({
            ad_storage: 'denied',
            analytics_storage: 'granted',
            personalization_storage: 'granted',
            functionality_storage: 'granted',
            security_storage: 'granted',
            wait_for_update: 1000,
            region: ['ES', 'US-AK']
          });
        }
      };
    });
    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage: 'granted',
      analytics_storage: 'denied',
      personalization_storage: 'denied',
      functionality_storage: 'denied',
      security_storage: 'denied',
      wait_for_update: 500
    });
    assertApi('setDefaultConsentState').wasCalledWith({
      ad_storage: 'denied',
      analytics_storage: 'granted',
      personalization_storage: 'granted',
      functionality_storage: 'granted',
      security_storage: 'granted',
      region: ['ES', 'US-AK'],
      wait_for_update: 1000
    });
    assertApi('gtmOnSuccess').wasCalled();
- name: dataLayer events generated
  code: "mockData.sendDataLayer = true;\n\nlet dlCalled = 0;\n\nmock('createQueue',\
    \ name => {\n  return o => {\n    require('logToConsole')(o);\n    if (o.ad_storage === 'granted' && o.analytics_storage\
    \ === 'denied' && o.personalization_storage === 'denied') dlCalled++;\n    if\
    \ (o.ad_storage === 'denied' && o.analytics_storage\
    \ === 'granted' && o.personalization_storage === 'granted' && o.consent_region.join()\
    \ === 'ES,US-AK') dlCalled++;\n  };\n});\n    \n// Call runCode to run the template's\
    \ code.\nrunCode(mockData);\n\n// Verify that the tag finished successfully.\n\
    assertApi('gtmOnSuccess').wasCalled();\nassertThat(dlCalled, 'dataLayer not called\
    \ with correct arguments').isEqualTo(2);"
setup: |-
  const mockData = {
    settingsTable: [
      {
      ad_storage: 'granted',
      analytics_storage: 'denied',
      personalization_storage: 'denied',
      functionality_storage: 'denied',
      security_storage: 'denied',
      wait_for_update: 500,
      regions: 'all'
      },
      {
      ad_storage: 'denied',
      analytics_storage: 'granted',
      personalization_storage: 'granted',
      functionality_storage: 'granted',
      security_storage: 'granted',
      wait_for_update: 1000,
      regions: 'ES, US-AK'
      }
    ],
    update_analytics_storage: 'granted',
    update_ad_storage: 'denied',
    update_personalization_storage: 'granted',
    update_functionality_storage: 'granted',
    update_security_storage: 'granted',
  };


___NOTES___

Created on 5/31/2023, 2:32:45 PM


